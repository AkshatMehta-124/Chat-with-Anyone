<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="wCG4UFi1An-_Wa6m1kO2MpMmuii7GOmAyI6G-XiGfEo" />
    <title>Chat with Anyone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="auth-screen" class="screen active">
        <div class="auth-box">
            <h1 class="app-title">Chat with Anyone</h1>
            <p id="auth-subtitle">Sign in to your account</p>
            <form id="auth-form">
                <input type="text" id="auth-name" placeholder="Full Name" style="display: none;">
                <input type="email" id="auth-email" placeholder="Email Address" required>
                <input type="password" id="auth-password" placeholder="Password" required>
                <button type="submit" id="auth-btn">Sign In</button>
            </form>
            <div class="divider"><span>OR</span></div>
            <button id="google-auth-btn">Continue with Google</button>
            <p class="toggle-text"><span id="toggle-auth-mode">Need an account? <b>Create one</b></span></p>
        </div>
    </div>

    <div id="app-screen" class="screen">
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div id="my-avatar" class="avatar"></div>
                    <span id="my-name">User</span>
                </div>
                <button id="logout-btn" class="icon-btn">Logout</button>
            </div>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="user-search" placeholder="Search users...">
                </div>
            </div>
            <div id="users-list" class="users-list"></div>
        </div>

        <div id="chat-window" class="chat-window hidden-mobile">
            <div id="no-chat-selected" class="no-chat">
                <h1>Chat with Anyone</h1>
                <p>Select a user to start messaging.</p>
            </div>
            <div id="active-chat" class="active-chat hidden">
                <div class="chat-header">
                    <button id="back-btn" class="icon-btn mobile-only">Back</button>
                    <div id="chat-avatar" class="avatar"></div>
                    <div class="chat-info">
                        <h3 id="chat-name">Name</h3>
                        <span id="chat-status" class="status-text">offline</span>
                    </div>
                </div>
                <div id="messages-container" class="messages-container"></div>
                <div id="typing-indicator" class="typing-indicator hidden">typing...</div>
                <form id="message-form" class="message-input-area">
                    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" id="send-btn">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_lmaWDdayWIOKK02h2uvZSeBasdUonXc",
            authDomain: "chat-with-anyone-73526.firebaseapp.com",
            projectId: "chat-with-anyone-73526",
            storageBucket: "chat-with-anyone-73526.firebasestorage.app",
            messagingSenderId: "440915092993",
            appId: "1:440915092993:web:96e7af7a1a05156ae6c200"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedUser = null;
        let isLoginMode = true;

        // Toggle Auth
        document.getElementById('toggle-auth-mode').onclick = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-name').style.display = isLoginMode ? 'none' : 'block';
            document.getElementById('auth-btn').innerText = isLoginMode ? 'Sign In' : 'Sign Up';
        };

        // Form Submit
        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(res.user, { displayName: name });
                    await setDoc(doc(db, "Users", res.user.uid), { uid: res.user.uid, name, email, online: true });
                }
            } catch (err) { alert(err.message); }
        };

        // Google Auth
        document.getElementById('google-auth-btn').onclick = async () => {
            const provider = new GoogleAuthProvider();
            const res = await signInWithPopup(auth, provider);
            await setDoc(doc(db, "Users", res.user.uid), { uid: res.user.uid, name: res.user.displayName, email: res.user.email, online: true }, { merge: true });
        };

        // Auth State
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.remove('active');
                document.getElementById('app-screen').classList.add('active');
                document.getElementById('my-name').innerText = user.displayName || 'User';
                document.getElementById('my-avatar').innerText = (user.displayName || 'U')[0].toUpperCase();
                loadUsers();
            } else {
                document.getElementById('auth-screen').classList.add('active');
                document.getElementById('app-screen').classList.remove('active');
            }
        });

        // Load Users
        function loadUsers() {
            onSnapshot(collection(db, "Users"), snap => {
                const list = document.getElementById('users-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    if (u.uid !== currentUser.uid) {
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.innerHTML = `<div class="avatar">${u.name[0]}</div><div class="user-details"><h4>${u.name}</h4></div>`;
                        div.onclick = () => openChat(u);
                        list.appendChild(div);
                    }
                });
            });
        }

        function openChat(user) {
            selectedUser = user;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('no-chat-selected').classList.add('hidden');
            document.getElementById('chat-name').innerText = user.name;
            document.getElementById('chat-avatar').innerText = user.name[0];
            loadMessages();
        }

        function loadMessages() {
            const q = query(collection(db, "Messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, snap => {
                const cont = document.getElementById('messages-container');
                cont.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    if ((m.sender === currentUser.uid && m.receiver === selectedUser.uid) || (m.sender === selectedUser.uid && m.receiver === currentUser.uid)) {
                        const div = document.createElement('div');
                        div.className = `message ${m.sender === currentUser.uid ? 'sent' : 'received'}`;
                        div.innerHTML = `<p>${m.text}</p>`;
                        cont.appendChild(div);
                    }
                });
                cont.scrollTop = cont.scrollHeight;
            });
        }

        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            await addDoc(collection(db, "Messages"), {
                text, sender: currentUser.uid, receiver: selectedUser.uid, timestamp: serverTimestamp()
            });
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
